<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>宅男甲的一亩三分地</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="专注于SDN/NFV虚拟化网络开发的技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="宅男甲的一亩三分地">
<meta property="og:url" content="http://lxu4net.gitcafe.io/index.html">
<meta property="og:site_name" content="宅男甲的一亩三分地">
<meta property="og:description" content="专注于SDN/NFV虚拟化网络开发的技术博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="宅男甲的一亩三分地">
<meta name="twitter:description" content="专注于SDN/NFV虚拟化网络开发的技术博客">
  
    <link rel="alternative" href="/atom.xml" title="宅男甲的一亩三分地" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="null" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">lxu4net</a></h1>
		</hgroup>

		
		<p class="header-subtitle">一个超级马里奥的历险</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="/#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Dragonflow/" style="font-size: 10px;">Dragonflow</a> <a href="/tags/Neutron/" style="font-size: 10px;">Neutron</a> <a href="/tags/OpenFlow/" style="font-size: 10px;">OpenFlow</a> <a href="/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/tags/SDN/" style="font-size: 10px;">SDN</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">lxu4net</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="null" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">lxu4net</h1>
			</hgroup>
			
			<p class="header-subtitle">一个超级马里奥的历险</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="/#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="/#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-dragonflow" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/08/16/dragonflow/" class="article-date">
  	<time datetime="2015-08-16T10:00:00.000Z" itemprop="datePublished">2015-08-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/16/dragonflow/">DragonFlow初体验</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        

        <p>之前就在考虑用OpenFlow实现虚拟路由的方法，正巧看见DragonFlow的介绍，原来已经有人先行了。</p>
<h1 id="DragonFlow的简介">DragonFlow的简介</h1><p>DragonFlow在其<a href="https://launchpad.net/dragonflow" target="_blank" rel="external">首页</a>上是这样介绍自己的：</p>
<p>Dragonflow是Neutron L3 Controller的扩展（add-on），实现了Neutron L3 Service APIs，提供分布式虚拟路由功能。</p>
<p>Dragonflow通过可插拔、无状态、轻量级SDN Controller完全分布式实现租户的跨子网（东西向）流量互通，不再需要流经网络节点，同时戏剧化的减少了计算节点的资源占用。</p>
<p>Dragonflow同样计划通过浮动IP（Floating IP）和SNAT（Shared IP）来分布式实现南北向流量。</p>
<p>Dragonflow计划在以下领域改善Openstack Neutron L3功能(虚拟路由):</p>
<ol>
<li>可扩展性 - 支持数以千计的计算节点</li>
<li>灵活性 - 保持控制器无状态以实现动态增长</li>
<li>性能 - 最小化计算节点的开销，没有中心化瓶颈</li>
<li>可靠性 - 服务连续性和高可用性</li>
</ol>
<p>Dragonflow的设计方针:</p>
<ol>
<li>非侵入式 - 依赖已有的抽象和可插拔模块</li>
<li>可插拔架构 (支持多种南向APIs, 例如：OVSDB, OpenFlow, Opflex)</li>
<li>利用多种风格 (例如： 同时支持主动式和响应式SDN Controller模式)</li>
<li>极简主义 - 轻快的实现，仅仅包括必需的并保持简单</li>
</ol>
<h1 id="特性列表">特性列表</h1><ul>
<li>东西向流量路由APIs</li>
<li>跨子网性能提升，因为不再需要kennel层(命名空间和TCP协议栈开销)</li>
<li>跨子网可扩展性提升，因为东西向L3流量路由直接在计算节点完成，不再需要转发到网络节点</li>
<li>跨子网可靠性提升，因为东西向L3流量不再需要转发到网络节点</li>
<li>简化虚拟路由管理</li>
<li>支持所有类型驱动：GRE/VXLAN/VLAN</li>
<li>通过复用传统L3实现，支持集中式共享公共网络(SNAT)</li>
<li>通过复用传统L3实现，支持集中式浮动IP(DNAT)</li>
<li>支持HA，当控制器连接断开，降级到传统L3实现，直到控制器连接恢复。复用所有传统L3 HA. (下一个发布将支持Controller HA).</li>
<li>通过复用传统L3实现，支持集中式IPv6</li>
</ul>
<h1 id="DragonFlow的实现">DragonFlow的实现</h1><p>首先看一下流表图建立一个全局概念：<br><img src="/images/df_of_pipeline.jpg" alt="DragonFlow流表概要" title="DragonFlow流表概要"></p>
<p>1) 流量分类<br>2) 按如下规则转发:</p>
<pre><code><span class="number">1.</span> 如果是ARP，转发到ARP应答表
<span class="number">2.</span> 如果需要路由(L3), 转发到L3转发表（实现虚拟路由）
<span class="number">3.</span> 所有的L2流量和本子网流量，由ML2的NORMAL流水线处理。
<span class="number">4.</span> 南北向流量被转发到网络节点(SNAT)
</code></pre><h2 id="基本缺省流水线">基本缺省流水线</h2><p>让我们首先分析devstack启动后配置的流表(通过运行<code>ovs-ofctl dump-flows br-int</code>获得)。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">0</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1</span> actions=goto_table:<span class="number">40</span></span><br><span class="line"><span class="number">2.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.757</span>s, table=<span class="number">0</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">0</span> actions=NORMAL</span><br><span class="line"><span class="number">3.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">0</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1000</span>,in_port=<span class="number">6</span> actions=NORMAL</span><br><span class="line"><span class="number">4.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">0</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1000</span>,in_port=<span class="number">2</span> actions=NORMAL</span><br><span class="line"><span class="number">5.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2211.729</span>s, table=<span class="number">23</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">0</span> actions=drop</span><br><span class="line"><span class="number">6.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">40</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">10</span>,dl_dst=<span class="number">01</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>/<span class="number">01</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> actions=NORMAL</span><br><span class="line"><span class="number">7.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">40</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1</span> actions=goto_table:<span class="number">52</span></span><br><span class="line"><span class="number">8.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">40</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">100</span>,dl_dst=ff:ff:ff:ff:ff:ff actions=NORMAL</span><br><span class="line"><span class="number">9.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">40</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1000</span>,arp actions=goto_table:<span class="number">51</span></span><br><span class="line"><span class="number">10.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">51</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1</span> actions=NORMAL</span><br><span class="line"><span class="number">11.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2205.752</span>s, table=<span class="number">52</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1</span> actions=goto_table:<span class="number">53</span></span><br><span class="line"><span class="number">12.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">2211.658</span>s, table=<span class="number">60</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1</span> actions=move:NXM_NX_TUN_ID[<span class="number">0.</span><span class="number">.31</span>]-&gt;NXM_NX_PKT_MARK[],output:<span class="number">6</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Table_0">Table 0</h3><p>主表0是新的数据包进入虚拟交换机的第一张表，流1是主表0的缺省流，他将所有从VM端口上收到的流量转到分类表40。</p>
<p>因为我们现在是单节点的配置，我们也能看到dhcp/patch-tun特定的流3和4将流量输出到NORMAL。（DHCP端口就是dnsmasq运行的一个namespace，连接到br-int）</p>
<h3 id="Table_40">Table 40</h3><p>流6和8匹配所有多播或广播流量(目的MAC为01:00:00:00:00:00 或 ff:ff:ff:ff:ff:ff), 将其输出到NORMAL路径。(Dragonflow自己没有处理L2的流表，但是他计划实现)</p>
<p>流9匹配所有的ARP报文，将其发送到表51。我们将会看到当添加虚拟路由器时Dragonflow将为路由端口在表51安装ARP响应流。</p>
<p>缺省流7将所有之前未匹配的流量发送到表52，其实现了虚拟路由器的功能。</p>
<h3 id="Table_51,_52_and_60">Table 51, 52 and 60</h3><p>流10是表51的缺省流，它将流量送往NORMAL流水线。</p>
<p>表52是L3分布虚拟路由实现表。流11是表52的缺省流，它将南北流量(SNAT/DNAT)从表52发往公共网络表53。</p>
<p>表60中的流12将tunnel id保存到报文的markup字段。虽然之前在表0中，已经有流表将tunnel id保存到报文的meta data字段，但是在报文在跨越bridge的边界到另一个bridge时，该信息会丢失，OVS仅保留markup字段不丢失。</p>
<h2 id="配置两个网络和一个路由器后的流水线">配置两个网络和一个路由器后的流水线</h2><p>在我们理解缺省流水线后，让我们增加两个网络net1（10.0.1.0/24）和net2（10.0.2.0/24）并用一个路由器将他们连接在一起。下图显示在Openstack UI中的网络拓扑。<br><img src="/images/dragonflow.topology1.jpeg" alt="网络拓扑1"></p>
<p>让我们重新检查流表，为了简化起见，我们仅关注新增的流，所有上一节的流表保持不变。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.423</span>s, table=<span class="number">0</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1000</span>,in_port=<span class="number">8</span> actions=NORMAL</span><br><span class="line"><span class="number">2.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.423</span>s, table=<span class="number">0</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">1000</span>,in_port=<span class="number">7</span> actions=NORMAL</span><br><span class="line"><span class="number">3.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.422</span>s, table=<span class="number">51</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, send_flow_rem priority=<span class="number">100</span>,arp,metadata=<span class="number">0x1f42</span>,arp_tpa=<span class="number">10.1</span><span class="number">.0</span><span class="number">.1</span>,arp_op=<span class="number">1</span> actions=set_field:<span class="number">2</span>-&gt;arp_op,move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:c0:<span class="number">8</span>d:<span class="number">8</span>b-&gt;eth_src,set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:c0:<span class="number">8</span>d:<span class="number">8</span>b-&gt;arp_sha,set_field:<span class="number">10.1</span><span class="number">.0</span><span class="number">.1</span>-&gt;arp_spa,IN_PORT</span><br><span class="line"><span class="number">4.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.423</span>s, table=<span class="number">51</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, send_flow_rem priority=<span class="number">100</span>,arp,metadata=<span class="number">0x1f43</span>,arp_tpa=<span class="number">10.2</span><span class="number">.0</span><span class="number">.1</span>,arp_op=<span class="number">1</span> actions=set_field:<span class="number">2</span>-&gt;arp_op,move:NXM_NX_ARP_SHA[]-&gt;NXM_NX_ARP_THA[],move:NXM_OF_ARP_SPA[]-&gt;NXM_OF_ARP_TPA[],set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:c5:<span class="number">02</span>:<span class="number">4</span>d-&gt;eth_src,set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:c5:<span class="number">02</span>:<span class="number">4</span>d-&gt;arp_sha,set_field:<span class="number">10.2</span><span class="number">.0</span><span class="number">.1</span>-&gt;arp_spa,IN_PORT</span><br><span class="line"><span class="number">5.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.423</span>s, table=<span class="number">52</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">20</span>,ip,metadata=<span class="number">0x1f43</span>,nw_dst=<span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> actions=CONTROLLER:<span class="number">65535</span></span><br><span class="line"><span class="number">6.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.421</span>s, table=<span class="number">52</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">30</span>,ip,metadata=<span class="number">0x1f42</span>,nw_dst=<span class="number">10.1</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> actions=NORMAL</span><br><span class="line"><span class="number">7.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.423</span>s, table=<span class="number">52</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">20</span>,ip,metadata=<span class="number">0x1f42</span>,nw_dst=<span class="number">10.2</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> actions=CONTROLLER:<span class="number">65535</span></span><br><span class="line"><span class="number">8.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">3063.423</span>s, table=<span class="number">52</span>, n_packets=<span class="number">0</span>, n_bytes=<span class="number">0</span>, priority=<span class="number">30</span>,ip,metadata=<span class="number">0x1f43</span>,nw_dst=<span class="number">10.2</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> actions=NORMAL</span><br></pre></td></tr></table></figure></p>
<h3 id="Table_0-1">Table 0</h3><p>我们看到流1和2匹配两个新增网络的DHCP端口，将其流量输出到NORMAL流水线。请记住这是因为我们现在运行的是单节点配置的devstack。</p>
<h3 id="Table_51">Table 51</h3><p>表51新增了两个流响应路由器接口的ARP查询。这些流在我们把网络连接到路由器接口时被配置。这些流匹配net1和net2的路由接口IP(10.1.0.1和10.2.0.1)的ARP查询，构造并返回包含虚拟MAC地址的ARP响应。</p>
<h3 id="Table_52">Table 52</h3><p>该表实现分布式虚拟路由功能，我们将会看到两类流。</p>
<p>流6和8匹配metadata（tunnel id）和目的IP子网，识别该流量为本地子网的内网通信（L2流量），将其输出到NORMAL流水线。以流8为例，tunnel id为0x1f43表明是net2，目的为10.2.0.0/24，和net2的子网一致。Dragonflow将匹配该流的流量输出到NORMAL流水线，然而未来Dragonflow也可以拥有L2流直接处理这些流量。</p>
<p>流5和7为另一类型，他们同样匹配metadata（tunnel id）和目的IP子网，但识别出流量为东西向的跨网流量（L3流量），将其送往控制器。以流5为例，tunnel id (metadata) 0x1f43表明流量来自net2，目的地址10.1.0.0/24表示去往net1，因此其为跨网L3流量，第一个匹配该流的报文将被送往控制器。流7匹配另一方向net1往net2的流量。</p>
<p>控制器将为东西向流量在所有计算节点安装可能的跨网流表，下一节将详细分析。</p>
<p>当前的流表还未优化，我们在计算节点上还没有VM时就已经安装了这些流。一个已经规划的优化任务是仅仅发送VM网络相关的流到计算节点。</p>
<h2 id="配置两台虚拟机后的流水线">配置两台虚拟机后的流水线</h2><p>让我们增加VM1，IP为10.1.0.3，连接到net1；Vm2，IP为10.2.0.3，连接到net2。<br><img src="/images/dragonflow.topology2.jpeg" alt="网络拓扑2"></p>
<p>变更流表如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">153.339</span>s, table=<span class="number">0</span>, n_packets=<span class="number">27</span>, n_bytes=<span class="number">2462</span>, priority=<span class="number">1000</span>,in_port=<span class="number">11</span> actions=write_metadata:<span class="number">0x1f42</span>/<span class="number">0xffff</span>,goto_table:<span class="number">40</span></span><br><span class="line"><span class="number">2.</span>cookie=<span class="number">0x0</span>, duration=<span class="number">149.796</span>s, table=<span class="number">0</span>, n_packets=<span class="number">23</span>, n_bytes=<span class="number">2182</span>, priority=<span class="number">1000</span>,in_port=<span class="number">12</span> actions=write_metadata:<span class="number">0x1f43</span>/<span class="number">0xffff</span>,goto_table:<span class="number">40</span></span><br></pre></td></tr></table></figure></p>
<p>这两条表0上的流表将匹配本地OVS端口，识别VM所归属的网络，将tunnel id写入metadata字段，并将该流量发往分流表40。</p>
<h2 id="控制器下发流表">控制器下发流表</h2><p>让我们从VM2 (10.2.0.3) ping VM1 (10.1.0.3)，看看发生了什么。</p>
<p>第一个报文首先到达表0，在那里它将匹配输入端口，网络ID（tunnel id）被写入他的metadata字段。</p>
<p>在表40，第一个报文被识别为查询求缺省网关IP的ARP请求，然后被送往表51。在表51，ARP响应流匹配IP和网络ID（tunnel id），发送包含路由器MAC地址的ARP响应。</p>
<p>下一个报文同样被写入网络ID（tunnel id）, 但它不是ARP，因此在分流表40被送往表52。表52识别其为东西向报文，发往控制器，随后控制器配置流：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cookie=<span class="number">0x1008000000019</span>, duration=<span class="number">5.704</span>s, table=<span class="number">52</span>, n_packets=<span class="number">1</span>, n_bytes=<span class="number">98</span>, idle_timeout=<span class="number">300</span>, priority=<span class="number">100</span>,ip,metadata=<span class="number">0x1f43</span>,in_port=<span class="number">12</span>,dl_src=fa:<span class="number">16</span>:<span class="number">3</span>e:cf:<span class="number">4</span>b:ed,dl_dst=fa:<span class="number">16</span>:<span class="number">3</span>e:c5:<span class="number">02</span>:<span class="number">4</span>d,nw_src=<span class="number">10.2</span><span class="number">.0</span><span class="number">.3</span>,nw_dst=<span class="number">10.1</span><span class="number">.0</span><span class="number">.3</span> actions=dec_ttl,set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:c5:<span class="number">02</span>:<span class="number">4</span>d-&gt;eth_src,set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">00</span>:<span class="number">17</span>:e6-&gt;eth_dst,output:<span class="number">11</span></span><br><span class="line">cookie=<span class="number">0x1008000040051</span>, duration=<span class="number">5.708</span>s, table=<span class="number">52</span>, n_packets=<span class="number">1</span>, n_bytes=<span class="number">98</span>, idle_timeout=<span class="number">300</span>, priority=<span class="number">100</span>,ip,metadata=<span class="number">0x1f42</span>,in_port=<span class="number">11</span>,dl_src=fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">00</span>:<span class="number">17</span>:e6,dl_dst=fa:<span class="number">16</span>:<span class="number">3</span>e:c0:<span class="number">8</span>d:<span class="number">8</span>b,nw_src=<span class="number">10.1</span><span class="number">.0</span><span class="number">.3</span>,nw_dst=<span class="number">10.2</span><span class="number">.0</span><span class="number">.3</span> actions=dec_ttl,set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:c0:<span class="number">8</span>d:<span class="number">8</span>b-&gt;eth_src,set_field:fa:<span class="number">16</span>:<span class="number">3</span>e:cf:<span class="number">4</span>b:ed-&gt;eth_dst,output:<span class="number">12</span></span><br></pre></td></tr></table></figure><br>这两条流表示两个VM间连接的两个方向。这两条流匹配VM的源、目的信息，然后修改源/目的MAC为从路由器接口到目的虚拟机。因为我们是单节点配置，在改完MAC后只需要转发报文到正确的输出端口。然而在多节点配置下，Dragonflow转发报文到br-tun，修改正确的tunnel-id，在不同的计算节点上配置2条流。</p>
<p>这些流被设置了idle_timeout, 在一段时间未匹配到后他们将会被删除。该参数包括hard_timeout在Dragonflow中可配置。</p>
<h2 id="总结">总结</h2><p>最后让我们回顾一下流表规则总结图：<br><img src="/images/DragonFlow流表规则.png" alt="DragonFlow流表规则" title="DragonFlow流表规则"></p>
<h2 id="参考资料：">参考资料：</h2><ul>
<li><a href="http://launchpad.net/dragonflow" target="_blank" rel="external">DragonFlow首页</a></li>
<li><a href="https://github.com/openstack/dragonflow" target="_blank" rel="external">DragonFlow代码</a></li>
<li><a href="http://galsagie.github.io/sdn/openstack/ovs/dragonflow/2015/05/09/dragonflow-1/" target="_blank" rel="external">Dragonflow Deep Dive (Part 1)</a></li>
<li><a href="http://galsagie.github.io/sdn/openstack/ovs/dragonflow/2015/05/11/dragonflow-2/" target="_blank" rel="external">Dragonflow Deep Dive (Part 2)</a></li>
<li><a href="https://www.ustack.com/blog/openstack-dragonflow/" target="_blank" rel="external">OpenStack网络新项目Dragonflow研究</a> </li>
<li><a href="https://www.ustack.com/blog/archsummit%EF%BC%8Dshenzhen/" target="_blank" rel="external">通向企业级的 OpenStack 网络服务</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dragonflow/">Dragonflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Neutron/">Neutron</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenFlow/">OpenFlow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenStack/">OpenStack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SDN/">SDN</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 lxu4net
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>